<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Train Scheduler</title>
  <!-- link to bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <!-- link to jquery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <!-- link to firebase -->
  <script src="https://www.gstatic.com/firebasejs/4.5.2/firebase.js"></script>
  <!-- Added Moment JS -->
  <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>
  <!-- link to reset, css and js -->
  <link rel="stylesheet" type="text/css" href="reset.css">
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" type="text/js" href="train.js">
</head>

<body>

  <!-- setting a container  -->
  <div class="container">
    <div class="jumbotron">
      <h1>trainTime</h1><br>
    <h1>Current Time:<h1 id="clocking"></h1></h1>
    </div>
    <!-- panel added -->
    <div class="panel panel-primary first">
      <div class="panel-heading">
        <h3 class="panel-title">Current Train Schedule</h3>
      </div>
      <div class="panel-body">
        <!-- adding table -->
        <table class="table table-striped table-hover ">
          <thead>
            <tr>
              <th>Train Name</th>
              <th>Destination</th>
              <th>Frequency (min)</th>
              <th>Next Arrival</th>
              <th>Minutes Away</th>
            </tr>
          </thead>
          <tbody id="usersTable">
            <tr></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- adding the second panel -->
    <div class="panel panel-primary second">
      <div class="panel-heading">
        <h3 class="panel-title">Add Train</h3>
      </div>
      <div class="panel-body">
        <!-- adding inputs -->
        <div class="form-group">
          <label class="control-label" for="focusedInput">Train Name</label><br><br>
          <input class="form-control" id="trainName" type="text" placeholder="Code Train">
        </div>

        <div class="form-group">
          <label class="control-label" for="focusedInput">Destination</label><br><br>
          <input class="form-control" id="destination" type="text" placeholder="Hackathon">
        </div>

        <div class="form-group">
          <label class="control-label" for="focusedInput">First Train Time (HH:mm - military time)</label><br><br>
          <input class="form-control" id="firstTrain" type="text" placeholder="10:00">
        </div>

        <div class="form-group">
          <label class="control-label" for="focusedInput">Frequency (min)</label><br><br>
          <input class="form-control" id="frequency" type="text" placeholder="5">
        </div>
        <button class="btn btn-primary" id="submit"> Submit </button>
      </div>


    </div>



  </div>

  <script type="text/javascript">
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBzl7cXRhc3xYBNL6NkmRog_e_um_mYTrQ",
      authDomain: "train-3312e.firebaseapp.com",
      databaseURL: "https://train-3312e.firebaseio.com",
      projectId: "train-3312e",
      storageBucket: "train-3312e.appspot.com",
      messagingSenderId: "1090813195958"
    };
    firebase.initializeApp(config);

    setInterval(function(){
        $('#clocking').html(moment().format('hh:mm:ss A'))
      }, 1000);

    var database = firebase.database();
    // Initial Values
    var trainName = "";
    var destination = "";
    var firstTrain = "";
    var frequency = "";

        $(document).ready(function() {


          $("#submit").on("click", function(event) {
            event.preventDefault();

            // Grabbed values from text boxes
            trainName = $("#trainName").val().trim();
            destination = $("#destination").val().trim();
            firstTrain = $("#firstTrain").val().trim();
            frequency = $("#frequency").val().trim();

            // console.log(trainName); // console.log(destination); // console.log(firstTrain); // console.log(frequency);
            // return false;
            // Code for handling the push
            database.ref().push({
              trainName: trainName,
              destination: destination,
              firstTrain: firstTrain,
              frequency: frequency,
              dateAdded: firebase.database.ServerValue.TIMESTAMP
            });

          });
          // Calculating time using moment.js

          database.ref().on("child_added", function(childSnapshot) {
            var cv = childSnapshot.val();
            // console.log(cv);
            var tFrequency = cv.frequency;
            // console.log(tFrequency);
            var firstTime = cv.firstTrain;
            var newDestination = cv.destination;
            var name = cv.trainName;
            var newFrequency = cv.frequency;
            var timer = moment().format('MMMM Do YYYY, h:mm:ss a');

            // First Time (pushed back 1 year to make sure it comes before current time)
            var firstTimeConverted = moment(firstTime, "hh:mm").subtract(1, "years");
            // console.log(firstTimeConverted);
            // Current Time
            var currentTime = moment();

            // Difference between the times
            // console.log(currentTime);
            var diffTime = moment().diff(moment.unix(firstTimeConverted), "minutes");
            // console.log(typeof(diffTime));
            // Time apart (remainder)
            var tRemainder = moment().diff(moment.unix(firstTimeConverted), "minutes") % tFrequency;
            // console.log(typeof(tRemainder));
            // Minute Until Train
            var tMinutesTillTrain = tFrequency - tRemainder;
            // console.log(typeof(tMinutesTillTrain));
            // Next Train
            var nextTrain = moment().add(tMinutesTillTrain, "minutes").format("hh:mm A");
            // console.log(nextTrain);

            // displaying the stored data in to the table

            $("#usersTable").append("<tr><td>" + name +
              "</td><td>" + newDestination +
              "</td><td>" + newFrequency +
              "</td><td>" + nextTrain + "</td><td>" + tMinutesTillTrain + "</td></tr>");
          });

        })
  </script>


</body>

</html>
